{% extends 'base.html' %}
{% load i18n %}
{% load render_bundle from webpack_loader %}
{% load static %}
{% block top_includes %}
    <link rel="stylesheet" type="text/css" href="/static/css/institutions.css" />
	<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.4/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.4/js/select2.min.js"></script>
    <style type="text/css">
        .select2-container.select2-container--default {
            width: 100% !important;
        }

        .select2-container--default .select2-selection--single {
            height: 34px !important;
            padding-left: 6px;
            padding-right: 6px;

            .select2-selection__placeholder {
                color: #333 !important;
            }

            .select2-selection__arrow {
                height: 34px !important;
            }
        }

        .flex-container {
            display: flex;
        }

        .flex-container .flex-item {
            flex: 1;
        }

        .max-w-600 {
            max-width: 600px;
        }

        .max-w-850 {
            max-width: 850px;
        }

        .w-label {
            min-width: 160px;
            max-width: 200px;
        }

        .xs-flex-container {
            display: flex;
        }

        .xs-flex-container .xs-flex-item {
            flex: 1;
        }

        .container-priority {
            display: flex;
            align-items: center;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            margin-right: 5px;
        }

        .btn-move {
            background-color: transparent;
            color: #007BFF;
            border: none;
            cursor: pointer;
        }

        .wrap-cell {
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal !important;
        }

        tr:first-child .btn-move.up {
            pointer-events: none;
            color: gray;
        }

        tr:last-child .btn-move.down {
            pointer-events: none;
            color: gray;
        }
    </style>
{% endblock %}
{% block title %}
    <title>{% trans "Project Limit Number Setting List" %}</title>
{% endblock title %}
{% block content %}
    <h2>{% trans "Project Limit Number Setting List" %}</h2>
    <form class="form-horizontal">
        {% csrf_token %}
        <div class="clearfix" style="margin-top: 20px;">
            <label for="institution_id" class="col-md-3" style="width: 22%; padding-right: 0px; padding-top: 6px;">{% trans 'Institution' %}</label>
            <div class="col-md-4" style="padding-left: 0px;">
                <select id="institution_id" name="institution_id" class="form-control" {% if is_admin %}disabled="disabled"{% endif %} onchange="changeInstitution()">
                    <option selected disabled hidden value="">{% trans 'Select institution' %}</option>
                    {% for institution in institutions %}
                        <option value="{{ institution.id }}"
                                {% if institution == selected_institution %}selected="selected"{% endif %}
                        >{{ institution.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        {% if selected_institution %}
        <div class="clearfix" style="margin-top: 20px;">
            <label for="project_limit_number_default_id" class="col-md-3" style="width: 22%; padding-top: 6px;">{% trans 'Project Limit Number Default' %}</label>
            <div class="col-md-4" style="padding-left: 0px;">
                <select id="project_limit_number_default_id" name="project_limit_numbers_default_name" class="form-control">
					<option {% if project_limit_number_default_value == -1 or project_limit_number_default_value is None %}selected{% endif %} value="-1">{% trans 'No Limit' %}</option>
                    {% for number in project_limit_number_default_list %}
                        <option value="{{ number }}" {% if project_limit_number_default_value == number %}selected{% endif %}>{{ number }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3" style="padding-left: 0px;">
                <button type="button" class="btn btn-primary" onclick="saveLimitNumberDefault()">{% trans "Save Default" %}</button>
            </div>
        </div>
        {% endif %}
    </form>

    {% if selected_institution %}
        <form>
            <div class="row col-md-12">
                {% include "project_limit_number/pagination.html" with institution_id=selected_institution.id items=page page_size=page_size %}
            </div>
            <div class="row col-md-12">
                <button id="save_changes_button" type="button" class="btn btn-primary" disabled onclick="saveSettings()">{% trans "Save Availability/Priority" %}</button>
                <button id="clear_changes_button" type="reset" class="btn btn-default" disabled style="margin-left: 5px;" onclick="resetSettings()">{% trans "Clear Availability/Priority" %}</button>
            </div>
        </form>
        <table id="setting-table" class="table table-striped table-hover table-responsive">
            <thead>
                <tr>
                    <th class="col-md-1 wrap-cell">{% trans "Priority" %}</th>
                    <th class="col-md-1 wrap-cell">{% trans "Availability" %}</th>
                    <th class="col-md-2 wrap-cell">{% trans "Setting Name" %}</th>
                    <th class="col-md-2 wrap-cell">{% trans "Rule Name" %}</th>
                    <th class="col-md-2 wrap-cell">{% trans "Memo" %}</th>
                    <th class="col-md-1 wrap-cell">{% trans "Created Time" %}</th>
                    <th class="col-md-1 wrap-cell">{% trans "Updated Time" %}</th>
                    <th class="col-md-2 wrap-cell">{% trans "Operation" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for setting in project_limit_number_setting_list %}
                    <tr>
                        <td class="wrap-cell">
                            <div class="container-priority">
                                <div class="button-group">
                                    <button type="button" class="btn-move up" {% if forloop.first %}disabled="disabled"{% endif %} onclick="moveRowUp(this)">↑</button>
                                    <button type="button" class="btn-move down" {% if forloop.last %}disabled="disabled"{% endif %} onclick="moveRowDown(this)">↓</button>
                                </div>
                                <input class="setting-id" type="hidden" value="{{ setting.id }}" />
                                <span class="setting-priority">{{ setting.priority }}</span>
                            </div>
                        </td>
                        <td class="wrap-cell">
                            <input type="checkbox" name="login_availability" checked="checked"
                                   value="{% if setting.is_availability %}on{% else %}off{% endif %}" style="height: 28px;"
                                   onchange="{this.classList.toggle('checked'); this.value = this.classList.contains('checked') ? 'on' : 'off';}"
                                   data-toggle="toggle" data-onstyle="success" class="btn apple-switch setting-availability {% if setting.is_availability %}checked{% endif %}">
                        </td>
                        <td class="wrap-cell">
                            {{ setting.setting_name|default_if_none:'' }}
                        </td>
                        <td class="wrap-cell">
                            {{ setting.template_name|default_if_none:'' }}
                        </td>
                        <td class="wrap-cell">
                            {{ setting.memo|default_if_none:'' }}
                        </td>
                        <td class="wrap-cell">
                            {{ setting.created|date:'Y-m-d H:i:s' }}
                        </td>
                        <td class="wrap-cell">
                            {{ setting.modified|date:'Y-m-d H:i:s' }}
                        </td>
                        <td class="col-md-12 wrap-cell" style="text-align: left; padding-left: 0px;">
                            <a class="btn btn-primary" style="margin-left: 10px" id="edit_authentication_attribute_{{ setting.id }}" name="editAuthenticationAttribute"
                                    href="{% url 'project_limit_number:settings:setting-detail' setting_id=setting.id %}">
                                {% trans "Edit" %}
                            </a>
                            <button type="button" class="btn btn-danger"
                                    data-target="#deleteSetting" data-toggle="modal"
                                    data-setting-id="{{ setting.id }}"
                                    style="margin-left: 10px" id="delete_authentication_attribute_{{ setting.id }}"
                                    name="deleteAuthenticationAttribute">
                                {% trans "Delete" %}
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <div>
            <a href="{% url 'project_limit_number:settings:create-setting'%}?institution_id={{selected_institution.id}}" class="btn btn-primary">{% trans "Create New" %}</a>
        </div>
    {% endif %}
    <div class="modal middle fade" id="deleteSetting" tabindex="-1" aria-labelledby="deleteSettingLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">x</button>
                    <h3>{% trans "Are you sure you want to delete this setting?" %}</h3>
                </div>
                <div class="modal-footer">
                    <button type="button" id="submitDeleteButton"
                            class="btn btn-danger"
                            data-dismiss="modal"
                            onclick="deleteSetting()">{% trans "Confirm" %}</button>
                    <button type="button"
                            class="btn btn-secondary cancel_modal"
                            data-dismiss="modal">{% trans "Cancel" %}</button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block bottom_js %}
    {% render_bundle 'project-limit-number-setting-page' %}
    <script type="text/javascript">
        let deleteSettingId;
        var changes = {
            priority: {},
            availability: {}
        };
        var changeSettingIdList = [];
        const csrftoken = $('[name=csrfmiddlewaretoken]').val();
        const originalTableHtml = $('#setting-table').html();
        $('#institution_id').select2({
            placeholder: "{% trans 'Select institution' %}"
        });
        $('#project_limit_number_default_id').select2();

        // When the modal is about to be shown, get the data from the button
        $('#deleteSetting').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget); // Button that triggered the modal
            deleteSettingId = Number(button.data('setting-id'), 10) || undefined;
        });

        function csrfSafeMethod(method) {
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            let rows = document.querySelectorAll('table tr');
            rows.forEach(updateMoveButtons);
        });

        $(document).on('change', '.setting-availability', function() {
            let row = $(this).closest('tr').get(0);
            let settingId = Number(row.querySelector('.setting-id').value, 10);
            let changeItem = changes.availability[settingId];
            if (!changes.availability[settingId]) {
                changes.availability[settingId] = {
                    new: this.checked
                }
                if (!changes.availability[settingId].old) {
                    changes.availability[settingId].old = !this.checked;
                }
            } else if (this.checked === changes.availability[settingId].old) {
                delete changes.availability[settingId];
            }
            updateChangeList();
        });

        function moveRowUp(button) {
            let currentRow = button.closest('tr');
            let previousRow = currentRow.previousElementSibling;

            if (previousRow) {
                currentRow.parentNode.insertBefore(currentRow, previousRow);

                // Update priorities
                updatePriority(currentRow);
                updatePriority(previousRow);

                // Disable/enable buttons as needed
                updateMoveButtons(currentRow);
                updateMoveButtons(previousRow);

                // Update change list
                updateChangeList();
            }
        }

        function moveRowDown(button) {
            let currentRow = button.closest('tr');
            let nextRow = currentRow.nextElementSibling;

            if (nextRow) {
                currentRow.parentNode.insertBefore(nextRow, currentRow);

                // Update priorities
                updatePriority(currentRow);
                updatePriority(nextRow);

                // Disable/enable buttons as needed
                updateMoveButtons(currentRow);
                updateMoveButtons(nextRow);

                // Update change list
                updateChangeList();
            }
        }

        function updatePriority(row) {
            let prioritySpan = row.querySelector('.container-priority span');
            if (prioritySpan) {
                let allRows = Array.from(row.parentNode.children);
                let pageOffset = {{ page_size|default:0 }} * ({{ page.number|default:0 }} - 1);
                let newPriority = pageOffset + allRows.indexOf(row) + 1;
                let settingId = Number(row.querySelector('.setting-id').value, 10);
                // Record the change
                if (!changes.priority[settingId]) {
                    let oldPriority = Number(prioritySpan.textContent, 10);
                    changes.priority[settingId] = {
                        new: newPriority
                    }
                    if (!changes.priority[settingId].old) {
                        changes.priority[settingId].old = oldPriority;
                    }
                } else if (newPriority === changes.priority[settingId].old) {
                    delete changes.priority[settingId];
                }
                prioritySpan.textContent = newPriority;
                updateChangeList();
            }
        }

        function updateMoveButtons(row) {
            let upButton = row.querySelector('.btn-move.up');
            let downButton = row.querySelector('.btn-move.down');
            let allRows = Array.from(row.parentNode.children);
            let rowIndex = allRows.indexOf(row);

            if (upButton) {
                upButton.disabled = (rowIndex === 0);  // Disable if it's the first row
            }
            if (downButton) {
                downButton.disabled = (rowIndex === allRows.length - 1);  // Disable if it's the last row
            }
        }

        function updateChangeList() {
            changeSettingIdList = [];

            // Process priority changes
            Object.entries(changes.priority).forEach(([settingId]) => {
                if (changeSettingIdList.indexOf(settingId) === -1) {
                    changeSettingIdList.push(Number(settingId, 10));
                }
            });

            // Process availability changes
            Object.entries(changes.availability).forEach(([settingId]) => {
                if (changeSettingIdList.indexOf(settingId) === -1) {
                    changeSettingIdList.push(Number(settingId, 10));
                }
            });

            toggleButtonState(changeSettingIdList.length === 0);
        }

        function saveLimitNumberDefault() {
            const projectLimitNumber = Number($('#project_limit_number_default_id').val(), 10);
            const data = {
                'institution_id': {{ selected_institution.id|default:0 }},
                'project_limit_number': projectLimitNumber
            };
            $.ajax({
                url: "{% url 'project_limit_number:settings:save-project-limit-number-default' %}",
                type: "put",
                data: JSON.stringify(data),
                dataType: "json",
                contentType: "application/json",
                success: function (response) {
                    window.location.reload();
                }
            }).fail(function (jqXHR, textStatus, error) {
                handleAjaxRequestFailure(jqXHR);
            });
        }

        function saveSettings() {
            // Disable clear button
            $('#clear_changes_button').prop('disabled', true);
            let tableData = [];
            // Extract data from table
            $('table tr:has(td)').each(function (index, element) {
                const id = Number(element.querySelector('.setting-id').value, 10);
                const priority = Number(element.querySelector('.setting-priority').innerText, 10) || undefined;
                const is_availability = element.querySelector('.setting-availability').value === 'on';
                if (changeSettingIdList.includes(id)) {
                    tableData.push({
                        id,
                        priority,
                        is_availability
                    });
                }
            });

            const data = {
                'institution_id': {{ selected_institution.id|default:0 }},
                'setting_list': tableData
            };
            $.ajax({
                url: "{% url 'project_limit_number:settings:save-settings-availability' %}",
                type: "put",
                data: JSON.stringify(data),
                dataType: "json",
                contentType: "application/json",
                success: function (response) {
                    window.location.reload();
                }
            }).fail(function (jqXHR, textStatus, error) {
                // Enable clear button
                $('#clear_changes_button').prop('disabled', false);
                handleAjaxRequestFailure(jqXHR);
            });
        }

        function deleteSetting() {
            $.ajax({
                url: "{% url 'project_limit_number:settings:delete-setting' setting_id=0%}".replace('0', deleteSettingId),
                type: "delete",
                dataType: "json",
                contentType: "application/json",
                success: function (response) {
                    const url = new URL(window.location.href);
                    const tableRows = $('#setting-table tbody tr').length;
                    const currentPage = url.searchParams.get('page');
                    if (tableRows <= 1 && currentPage !== 'last' && currentPage > 1) {
                        url.searchParams.set('page', currentPage - 1);
                        window.location.href = url.toString();
                    } else {
                        window.location.reload();
                    }
                }
            }).fail(function (jqXHR, textStatus, error) {
                // Find the focused element
                const focusedElement = document.activeElement;
                if (focusedElement) {
                    const ancestorDiv = focusedElement.closest('div[aria-hidden="true"]');
                    if (ancestorDiv) {
                        // Remove the ancestor div
                        ancestorDiv.remove();
                    }
                }
                handleAjaxRequestFailure(jqXHR);
            });
        }

        function resetSettings() {
            $('#setting-table').html(originalTableHtml);
            toggleButtonState(true);
        }

        function changeInstitution() {
            const institution_id = $('#institution_id').val();
            window.location.href='?institution_id=' + institution_id;
        }

        function toggleButtonState(disabled) {
            $('#save_changes_button').prop('disabled', disabled);
            $('#clear_changes_button').prop('disabled', disabled);
        }
    </script>
{% endblock %}
