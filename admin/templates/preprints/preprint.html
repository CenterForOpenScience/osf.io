{% extends 'base.html' %}
{% load static %}
{% load user_extras %}
{% load node_extras %}
{% block title %}
    <title>Preprint</title>
{% endblock title %}
{% block content %}
    <div class="container-fluid">
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
        <div class="row">
            <div class="col-md-12">
                <div class="btn-group" role="group">
                    <a href="{% url 'preprints:search' %}"
                       class="btn btn-primary">
                        <i class="fa fa-search"></i>
                    </a>
                    {% if perms.osf.delete_preprint %}
                        {% if not preprint.deleted %}
                            <a href="{% url 'preprints:remove' guid=preprint.guid %}" data-toggle="modal" data-target="#deleteModal" class="btn btn-danger">
                                Delete Preprint
                            </a>
                            <div class="modal" id="deleteModal">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <form class="well" method="post" action="{% url 'preprints:remove' guid=preprint.guid %}">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal">x</button>
                                                <h3>Are you sure you want to delete this preprint? {{ preprint.guid }}</h3>
                                            </div>
                                            <div class="modal-body">
                                                This action will be reversible after the fact.
                                                {% csrf_token %}
                                            </div>
                                            <div class="modal-footer">
                                                <input class="btn btn-danger" type="submit" value="Confirm" />
                                                <button type="button" class="btn btn-default"
                                                        data-dismiss="modal">
                                                    Cancel
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <form method="post" action="{% url 'preprints:restore' guid=preprint.guid %}" style="display: inline;">
                                {% csrf_token %}
                                <input class="btn btn-success" type="submit" value="Restore Preprint" />
                            </form>
                        {% endif %}
                    {% endif %}

                    {% include "preprints/confirm_spam.html" with preprint=preprint %}
                    {% include "preprints/reindex_preprint_share.html" with preprint=preprint %}

                </div>
            </div>
        </div>
        <div class="row">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>GUID</td>
                        <td>{{ preprint.guid }}</td>
                    </tr>
                    <tr>
                        <td>Title</td>
                        <td>{{ preprint.title }}</td>
                    </tr>
                    <tr>
                        <td>Date Created</td>
                        <td>{{ preprint.created | date }}</td>
                    </tr>
                    <tr>
                        <td>Date Modified</td>
                        <td>{{ preprint.modified | date }}</td>
                    </tr>
                    <tr>
                        <td>Creator</td>
                        <td>
                             <a href="{{ preprint.creator.id | reverse_user }}">
                                {{ preprint.creator }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td>Deleted</td>
                        <td>{{ preprint.deleted | date }}</td>
                    </tr>
                    <tr>
                        <td>Public</td>
                        <td>{{ preprint.is_public }}</td>
                    </tr>
                    <tr>
                        <td>Published</td>
                        <td>{{ preprint.is_published }}</td>
                    </tr>
                    {%  if preprint.is_published %}
                        <tr>
                            <td>Date Published</td>
                            <td>{{ preprint.date_published }} UTC</td>
                        </tr>
                    {%  endif %}
                    <tr>
                        <td>Verified Publishable</td>
                        <td>{{ preprint.verified_publishable }}</td>
                    </tr>
                    <tr>
                        <td>Node</td>
                        <td>
                            {% if preprint.node %}
                                <a href="{{ preprint.node.id | reverse_node }}">{{ preprint.node.title }}</a>
                            {% else %}
                                None
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td>Provider</td>
                        <td>
                            {{ preprint.provider.name }}
                            {% if perms.osf.change_preprint %}
                                <a class="btn btn-link" role="button" data-toggle="collapse" href="#collapseChangeProvider">
                                    Change preprint provider
                                </a>
                                <div class="collapse" id="collapseChangeProvider">
                                    <div class="well">
                                        <form action="{% url 'preprints:preprint' guid=preprint.guid %}" method="post">
                                            {% csrf_token %}
                                            {{ form.as_p }}
                                            <input class="btn-btn-primary" type="submit" value="Submit" />
                                        </form>
                                    </div>
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td>Subjects</td>
                        <td>
                            <ul>
                                {% for subject in preprint.subjects.all %}
                                    <li>{{ subject.text }}</li>
                                {% endfor %}
                            </ul>
                        </td>
                    </tr>
                    {% include "preprints/contributors.html" with preprint=preprint %}
                    {% include "nodes/spam_status.html" with resource=preprint %}
                    {% if perms.osf.change_preprintrequest %}
                    <tr>
                        <td>Withdrawal Request</td>
                        <td>
                            <table class="table table-hover">
                            <thead>
                                <tr>
                                    <td>Withdrawal Justification</td>
                                    <td>Creator</td>
                                    <td>Status</td>
                                    <td>Created</td>
                                    <td></td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="width: 500px;"> {{ preprint.withdrawal_request.comment }} </td>
                                    <td> {{ preprint.withdrawal_request.creator.fullname }} </td>
                                    <td>
                                        {% if preprint.withdrawal_request.machine_state == 'accepted' %}
                                            <span class="label label-success">Approved</span>
                                        {% elif preprint.withdrawal_request.machine_state == 'rejected' %}
                                            <span class="label label-danger">Rejected</span>
                                        {% elif preprint.withdrawal_request.machine_state == 'pending' %}
                                            <span class="label label-default">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td> {{ preprint.withdrawal_request.created }} </td>
                                    {% if preprint.pending_withdrawal %}
                                    <td>
                                        <span>
                                            <a href="{% url 'preprints:approve-withdrawal' guid=preprint.guid %}"
                                               data-toggle="modal" data-target="#confirmApproveWithdrawal"
                                               class="btn btn-warning btn-sm">
                                                Approve
                                            </a>
                                            <div class="modal" id="confirmApproveWithdrawal">
                                                <div class="modal-dialog">
                                                    <div class="modal-content"></div>
                                                    {# Data from above link #}
                                                </div>
                                            </div>
                                        </span>&nbsp;&nbsp;
                                        <span>
                                            <a href="{% url 'preprints:reject-withdrawal' guid=preprint.guid %}"
                                               data-toggle="modal" data-target="#confirmRejectWithdrawal"
                                               class="btn btn-default btn-sm">
                                                Reject
                                            </a>
                                            <div class="modal" id="confirmRejectWithdrawal">
                                                <div class="modal-dialog">
                                                    <div class="modal-content"></div>
                                                    {# Data from above link #}
                                                </div>
                                            </div>
                                        </span>
                                    </td>
                                    {% endif %}
                                </tr>
                            </tbody>
                            </table>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock content %}
