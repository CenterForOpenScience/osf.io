{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% load render_bundle from webpack_loader %}

{% block top_includes %}
    <link rel="stylesheet" type="text/css" href="/static/css/institutions.css"/>
{% endblock %}

{% block title %}
    <title>{% trans "Export Data List" %}</title>
{% endblock title %}

{% block content %}
    <h2>{% trans "Export Data List" %}<br/><small>(for {{ institution.name }})</small></h2>

    <form method="get" action="{% url 'custom_storage_location:export_data:export_data_list' %}" class="form-horizontal" id="entitlements_form">
        <div class="form-group">
            <label class="col-sm-2 control-label text-left">Export source storage</label>
            <div class="col-sm-9">
                <select class="form-control" name="storage_name" style="max-width: 320px;">
                    {% for storage in list_storage %}
                        {% if storage.id == selected_source %}
                            <option value={{ storage.id }} selected="selected">{{ storage.name }}</option>
                        {% else %}
                            <option value={{ storage.id }}>{{ storage.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label text-left" style="">{% trans "Export data storage location" %}</label>
            <div class="col-sm-9" style="display: flex; gap: 10px;">
                <select class="form-control" name="location_export_name" style="max-width: 320px; flex: auto">
                    {% for location in list_location %}
                        {% if location.id == selected_location_export %}
                            <option value={{ location.id }} selected="selected">{{ location.name }}</option>
                        {% else %}
                            <option value={{ location.id }}>{{ location.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <div class="btn-group" role="group" aria-label="..." style="flex: initial;">
                    <button type="button" class="btn btn-primary" style="min-width: 90px;">{% trans "Export" %}</button>
                    <button type="button" class="btn btn-primary disabled"
                            style="min-width: 90px;">{% trans "Stop exporting" %}
                    </button>
                </div>
            </div>
        </div>
        <div class="form-group" id="formFilter">
            <div class="col-sm-12">
                {% if list_location %}
                    <button type="submit" id="filter_export" class="btn btn-primary" style="min-width: 90px;">{% trans "Filter" %}</button>
                {% else %}
                    <button type="submit" id="filter_export" class="btn btn-primary" style="min-width: 90px;" disabled>{% trans "Filter" %}</button>
                {% endif %}
                <a class="text-white" href={% url 'custom_storage_location:export_data:export_data_deleted_list' %}>
                    <button type="button" class="btn btn-primary" style="min-width: 90px; margin-left:10px;">
                        {% trans "Revert Export Data" %}
                    </button>
                </a>
            </div>
        </div>
    </form>
    {% include "util/pagination.html" with items=page status=status %}
    <table class="table table-striped table-hover table-bordered table-responsive">
        <thead>
        <tr>
            <th width="20px">
                <input type="checkBox" id="check_delete_export_all" style="width: 15px; height: 15px;">
            </th>
            <th>{% trans "ID" %}</th>
            <th>{% trans "Export source storage" %}</th>
            <th>{% trans "Export data storage location" %}</th>
            <th>{% trans "Process start" %}</th>
            <th>{% trans "Process end" %}</th>
            <th>{% trans "Number of projects" %}</th>
            <th>{% trans "Number of files" %}</th>
            <th>{% trans "Total file size" %}</th>
        </tr>
        </thead>
        <tbody>
        {% for item in list_export_data %}
            <tr class="">
                <td width="20px">
                    <input type="checkBox" name="check_delete_export" id={{ item.export_data.id }} title="" style="width: 14px; height: 14px;">
                </td>
                <td class=""><a href={% url 'custom_storage_location:export_data:export_data_information' item.export_data.id %}>{{ item.export_data.id }}</a></td>
                <td class="">{{ item.source_name }}</td>
                <td class="">{{ item.location_name }}</td>
                <td class="">{{ item.export_data.process_start }}</td>
                <td class="">{{ item.export_data.process_end }}</td>
                <td class="">{{ item.export_data.project_number }}</td>
                <td class="">{{ item.export_data.file_number }}</td>
                <td class="">{{ item.export_data.total_size }} KB</td>
                <!--<td class=""></td>-->
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <button type="button" class="btn btn-danger" id="delete_button"
            data-target="#deleteExport" data-toggle="modal">{% trans "Delete" %}</button>

    <style type="text/css">
        .modal.middle {
            text-align: center;
            padding: 0 !important;
        }

        .modal.middle:before {
            content: '';
            display: inline-block;
            height: 100%;
            vertical-align: middle;
            margin-right: -4px; /* Adjusts for spacing */
        }

        .modal.middle .modal-dialog {
            display: inline-block;
            text-align: left;
            vertical-align: middle;
        }
    </style>

    <div class="modal middle fade" id="deleteExport" tabindex="-1" aria-labelledby="deleteExportLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form method="post" action={% url 'custom_storage_location:export_data:export_data_delete' %}>
                {% csrf_token %}
                <div class="modal-content">
                    <!--<div class="modal-header">-->
                    <!--    <h4 class="modal-title" id="deleteExportLabel">Confirm to delete</h4>-->
                    <!--</div>-->
                    <div class="modal-body" id="bodydeleteExport">
                        <p>Are you sure you want to delete these export data?</p>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="delete_permanently"> Permanently delete (Cannot be restored with the Revert button)
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary cancel_modal" data-dismiss="modal">Cancel</button>
                        <button type="submit" id="submitDeleteButton" class="btn btn-danger" disabled>Delete</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script type="text/javascript">
        $(document).ready(() => {
            $('#check_delete_export_all').on('change', () => {
                let check = $('#check_delete_export_all').is(':checked');
                if (check) {
                    $('input[type=checkbox][name=check_delete_export]').prop('checked', true);
                } else {
                    $('input[type=checkbox][name=check_delete_export]').prop('checked', false);
                }
            });
            $('#delete_button').on('click', () => {
                let list_export_data = $('input[type=checkbox][name=check_delete_export]');
                let list_export_id = '';
                for (let i = 0; i < list_export_data.length; i++) {
                    if (list_export_data[i].checked) {
                        list_export_id += list_export_data[i].id + '#';
                    }
                }
                if (list_export_id.length > 0) {
                    $('#submitDeleteButton').removeAttr('disabled');
                }
                $('#bodydeleteExport').append(`<input type='text' value=${list_export_id} id='input_export_data' class='buckinput' name='list_id_export_data' style='display: none;' />`);
                $('#bodydeleteExport').append(`<input type='text' value={{source_id}} id='source_id' class='buckinput' name='source_id' style='display: none;' />`);
            });
            $('input[type=checkbox][name=check_delete_export]').on('change', () => {
                let list_export_data = $('input[type=checkbox][name=check_delete_export]');
                let count_checked = $('input[type=checkbox][name=check_delete_export]:checked').length;
                if (count_checked !== list_export_data.length) {
                    $("#check_delete_export_all").prop('checked', false);
                } else {
                    $("#check_delete_export_all").prop('checked', true);
                }
            });
            $('.cancel_modal').on('click', () => {
                $('#input_export_data').remove();
                $('#source_id').remove();
            });
        });
    </script>
{% endblock content %}

{% block bottom_js %}
    {% render_bundle 'rdm-institutional-storage-page' %}
{% endblock %}