{% extends "base.html" %}
{% load static %}
{% block top_includes %}
  <link rel="stylesheet" type="text/css" href="/static/css/institutions.css" />
{% endblock %}
{% load user_extras %}
{% load spam_extras %}
{% block title %}
    <title>TimeStampAddList</title>
{% endblock title %}
{% block content %}
<h3>TimeStamp Add ({{ project_title }})</h3>
<form action "" id="addTimestampForm">
<div class="row">
    <div class="col-md-12">
        <a class="btn btn-success" id="btn-verify">Verify</a>
        <a class="btn btn-success" id="btn-addtimestamp">Request Trusted Timestamp</a>
        <font color="red">
            <h4 id="timestamp_errors_spinner"></h4>
        </font>
    </div>
<table id="datatables" class="table table-striped table-bordered" cellspacing="0" width="100%">
    <thead>
        <tr>
            <th>FilePath</th>
            <th>TimestampUpdateUser</th>
            <th>TimestampUpdateDate</th>
            <th>Timestamp verification</th>
        </tr>
    </thead>
    <tbody id="timestamp_error_list">
    </tbody>

</table>
{% csrf_token %}
</form>
</div>
{% endblock content %}

{% block bottom_js %}
    <script>
         $(function(){
            function getCookie(name) {
               var cookieValue = null;
               if (document.cookie && document.cookie != '') {
                   var cookies = document.cookie.split(';');
                   for (var i = 0; i < cookies.length; i++) {
                      var cookie = jQuery.trim(cookies[i]);
                      // Does this cookie string begin with the name we want?
                      if (cookie.substring(0, name.length + 1) == (name + '=')) {
                         cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                         break;
                      }
                   }
               }
               return cookieValue;
            }
            var csrftoken = getCookie('admin-csrf');
            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }
            $.ajaxSetup({
                 crossDomain: false, // obviates need for sameOrigin test
                 beforeSend: function(xhr, settings) {
                     if (!csrfSafeMethod(settings.type)) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                     }
                 }
            });

            var btnVerify_onclick = function(event) {
                if($("#btn-verify").attr("disabled") != undefined || $("#btn-addtimestamp").attr("disabled") != undefined) {
                    return false;
                }
                var button = $(this);
                $("#btn-verify").attr("disabled", true);
                $("#btn-addtimestamp").attr("disabled", true);
                $("#timestamp_errors_spinner").text("Storage files list gathering ...");
                var post_data = {}
                var fileCnt = 0;
                $.ajax({
                    url: "{% url 'timestampadd:verify' institution_id=institution_id guid=guid %}",
                    data: post_data,
                    dataType: 'json',
                    method: 'POST'
                }).done(function(data) {
                    //console.log(data);
                    var project_file_list = data["provider_file_list"];
                    for (var i = 0; i < project_file_list.length; i++) {
                        var file_list = project_file_list[i].provider_file_list;
                        for (var j = 0; j < file_list.length; j++) {
                           fileCnt++;
                        }
                    }
                    //console.log(fileCnt);
                    var url = "{% url 'timestampadd:verify_data' institution_id=institution_id guid=guid %}"
                    var successCnt = 0;
                    for (var i = 0; i < project_file_list.length; i++) {
                        var file_list = project_file_list[i].provider_file_list;
                        var provider_output_flg = false;
                        for (var j = 0; j < file_list.length; j++) {
                            var post_data = {'provider': project_file_list[i].provider,
                                             'file_id': file_list[j].file_id,
                                             'file_path': file_list[j].file_path,
                                             'file_name': file_list[j].file_name,
                                             'version': file_list[j].version};
                            //console.log(post_data);
                            $.ajax({
                                    url: "{% url 'timestampadd:verify_data' institution_id=institution_id guid=guid %}",
                                    data: post_data,
                                    dataType: 'json',
                                    method: 'POST'
                            }).done(function(data) {
                                    successCnt++;
                                    //console.log(successCnt);
                                    //console.log(post_data);
                                    $("#timestamp_errors_spinner").text("Verification files : " + successCnt + " / " + fileCnt + " ...");
                                    if (successCnt == fileCnt) {
                                       button.removeAttr("disabled");
                                       $("#timestamp_errors_spinner").text("Verification (100%) and Refreshing...");
                                       window.location.reload();
                                    }
                            }).fail(function(xhr, status, error) {
                                    $("#btn-verify").removeAttr("disabled");
                                    $("#btn-addtimestamp").removeAttr("disabled");
                                    $("#timestamp_errors_spinner").text("Error : " + file_list[j].file_path);
                                    Raven.captureMessage('Timestamp Add Error: ' + filePathList[index], {
                                         extra: {
                                             url: "{% url 'timestampadd:add_timestamp_data' institution_id=institution_id guid=guid %}",
                                             status: status,
                                             error: error
                                         }
                                    });
                            });
                        }
                    }
                    //$("#timestamp_errors_spinner").text("Verification refreshing...");
                }).fail(function(xhr, status, error) {
                    $("#btn-verify").removeAttr("disabled");
                    $("#btn-addtimestamp").removeAttr("disabled");
                    $("#timestamp_errors_spinner").text("Error : Storage files list gathering Failed");
                    Raven.captureMessage('Timestamp Add Error: ', {
                      extra: {
                        url: "{% url 'timestampadd:add_timestamp_data' institution_id=institution_id guid=guid %}",
                        status: status,
                        error: error
                      }
                    });
                });
            };

            var btnAddtimestamp_onclick = function(event) {
                if($("#btn-verify").attr("disabled") != undefined || $("#btn-addtimestamp").attr("disabled") != undefined) {
                    return false;
                }
                var button = $(this);
                var inputCheckBoxs = $("[id=addTimestampCheck]:checked").map(function (index, el) {
                    return $(this).val();
                });

                if (inputCheckBoxs.length == 0) {
                    return false;
                }

                providerList = $('[id=provider]').map(function (index, el) {
                    return $(this).val();
                });
                fileIdList = $('[id="file_id"]').map(function (index, el) {
                    return $(this).val();
                });
                filePathList = $('[id=file_path]').map(function (index, el) {
                    return $(this).val();
                });
                versionList = $('[id=version]').map(function (index, el) {
                    return $(this).val();
                });
                fileNameList = $('[id=file_name]').map(function (index, el) {
                    return $(this).val();
                });

                $("#btn-verify").attr("disabled", true);
                $("#btn-addtimestamp").attr("disabled", true);
                $("#timestamp_errors_spinner").text("Addtimestamp loading ...");
                var url = "{% url 'timestampadd:addtimestamp' institution_id=institution_id guid=guid %}"
                var successCnt = 0;
                //console.log("check : " + inputCheckBoxs.length);
                for (var i = 0; i < inputCheckBoxs.length; i++) {
                     index = inputCheckBoxs[i];
                     var post_data = {'provider': providerList[index],
                                      'file_id': fileIdList[index],
                                      'file_path': filePathList[index],
                                      'file_name': fileNameList[index],
                                      'version': versionList[index]};
                     //console.log(post_data);
                     $.ajax({
                          url: "{% url 'timestampadd:add_timestamp_data' institution_id=institution_id guid=guid %}",
                          data: post_data,
                          dataType: 'json',
                          method: 'POST'
                     }).done(function(data) {
                          successCnt++;
                          //console.log(successCnt);
                          //console.log(post_data);
                          $("#timestamp_errors_spinner").text("Adding Timestamp files : " + successCnt + " / " + inputCheckBoxs.length + " ...");
                          if (successCnt ==  inputCheckBoxs.length) {
                             button.removeAttr("disabled");
                             $("#timestamp_errors_spinner").text("Added Timestamp (100%) and Refreshing...");
                             window.location.reload();
                          }
                     }).fail(function(xhr, status, error) {
                        $("#btn-verify").removeAttr("disabled");
                        $("#btn-addtimestamp").removeAttr("disabled");
                        $("#timestamp_errors_spinner").text("");
                        Raven.captureMessage('Timestamp Add Error: ' + filePathList[index], {
                            extra: {
                                url: "{% url 'timestampadd:add_timestamp_data' institution_id=institution_id guid=guid %}",
                                status: status,
                                error: error
                            }
                        });
                     });
                 }              
            };

            var document_onready = function (event) {
                 $("#btn-verify").on("click", btnVerify_onclick).focus();
                 $("#btn-addtimestamp").on("click", btnAddtimestamp_onclick).focus();
                 var provider = '';
                 var index = 0;
                 {% for provider_error_info in init_project_timestamp_error_list %}
                    //console.log('{{ provider_error_info }}');
                    var provider_tr = '<tr><td colspan="4">{{ provider_error_info.provider }}</td></tr>';
                    $(provider_tr).appendTo($('#timestamp_error_list'));
                    {% for error_info in provider_error_info.error_list %}
                         var error_tr = '<tr>' +
                                        '<td class="addTimestamp">' +
                                        '<input type="checkBox" id="addTimestampCheck" value="' + index + '"/>&nbsp;&nbsp;' +
                                        '{{ error_info.file_path }}' +
                                        '<input type="hidden" name="provider" id="provider" value="{{ provider_error_info.provider }}" />' +
                                        '<input type="hidden" name="file_id" id="file_id" value="{{ error_info.file_id }}" />' +
                                        '<input type="hidden" name="file_path" id="file_path" value="{{ error_info.file_path }}" />' +
                                        '<input type="hidden" name="project_id" id="project_id" value="{{ error_info.project_id }}" />' +
                                        '<input type="hidden" name="version" id="version" value="{{ error_info.version }}" />' +
                                        '<input type="hidden" name="file_name" id="file_name" value="{{ error_info.file_name }}" />' +
                                        '</td>' +
                                        '<td>{{ error_info.operator_user }}</td>' +
                                        '<td>{{ error_info.operator_date }}</td>' +
                                        '<td>{{ error_info.verify_result_title }}</td>' +
                                        '</tr>';
                         //console.log(error_tr);
                         $(error_tr).appendTo($('#timestamp_error_list'));
                         index++;
                    {% endfor %}
                 {% endfor %} 
          };
            $(document).ready(document_onready);
       });
  </script>

{% endblock %}
